import { EventArchitecture } from './EventArchitecture';
import { MissionBrain } from './MissionBrain';
import { PrestigeSystem } from './PrestigeSystem';
import { EsportsMode } from './EsportsMode';
import { AntiCheatSystem } from './AntiCheatSystem';
import { PsychologicalRetention } from './PsychologicalRetention';
import { MatchEnginePhysics } from './MatchEnginePhysics';
import { PlayerState, MatchState } from '../types/MatchEngineTypes';

/**
 * Master integration controller for all advanced game systems
 * Coordinates interactions between Event Architecture, Mission Brain, Prestige System,
 * Esports Mode, Anti-Cheat, Psychological Retention, and Match Engine Physics
 */
export class GameSystemsIntegration {
  private eventArchitecture: EventArchitecture;
  private missionBrain: MissionBrain;
  private prestigeSystem: PrestigeSystem;
  private esportsMode: EsportsMode;
  private antiCheatSystem: AntiCheatSystem;
  private retentionModel: PsychologicalRetention;
  private matchEngine: MatchEnginePhysics;
  
  private playerSessions: Map<string, PlayerSession> = new Map();
  private systemMetrics: SystemMetrics;

  constructor() {
    this.initializeSystems();
    this.systemMetrics = new SystemMetrics();
  }

  private initializeSystems(): void {
    this.eventArchitecture = new EventArchitecture();
    this.missionBrain = new MissionBrain();
    this.prestigeSystem = new PrestigeSystem();
    this.esportsMode = new EsportsMode();
    this.antiCheatSystem = new AntiCheatSystem();
    this.retentionModel = new PsychologicalRetention();
    this.matchEngine = new MatchEnginePhysics();
  }

  /**
   * Start a player session with all systems initialized
   */
  public startPlayerSession(playerId: string, playerState: PlayerState): void {
    const session: PlayerSession = {
      playerId,
      startTime: Date.now(),
      playerState,
      activeEvents: [],
      activeMissions: [],
      prestigeData: this.prestigeSystem.getPlayerPrestige(playerId),
      esportsData: this.esportsMode.getPlayerMMR(playerId),
      retentionProfile: this.retentionModel.getPlayerProfile(playerId),
      antiCheatProfile: this.antiCheatSystem.getBehavioralProfile(playerId),
      matchPhysics: this.matchEngine.initializePlayer(playerId, playerState)
    };

    this.playerSessions.set(playerId, session);

    // Initialize mission generation based on player behavior
    this.missionBrain.generateDailyMissions(playerId, session.retentionProfile);
    this.missionBrain.generateWeeklyMissions(playerId, session.retentionProfile);

    // Check for available events
    const activeEvents = this.eventArchitecture.getActiveEvents();
    session.activeEvents = activeEvents.filter(event => 
      this.eventArchitecture.participateInEvent(playerId, event.eventId)
    );

    // Start retention monitoring
    this.retentionModel.startSession(playerId);
  }

  /**
   * Process match completion across all systems
   */
  public processMatchCompletion(
    playerId: string, 
    matchState: MatchState, 
    result: 'win' | 'loss' | 'draw',
    performance: MatchPerformance
  ): void {
    const session = this.playerSessions.get(playerId);
    if (!session) return;

    // 1. Anti-Cheat validation first
    const antiCheatResult = this.antiCheatSystem.validateMatch(
      playerId, 
      matchState, 
      performance
    );

    if (!antiCheatResult.isValid) {
      this.handleAntiCheatViolation(playerId, antiCheatResult);
      return;
    }

    // 2. Update Esports MMR
    const mmrChange = this.esportsMode.updateMMR(playerId, result, performance);

    // 3. Process Event participation
    for (const eventId of session.activeEvents) {
      this.eventArchitecture.recordEventAction(
        playerId, 
        eventId, 
        'match_complete', 
        {
          result: result === 'win' ? 1 : 0,
          performance: performance.score,
          cleanPlay: performance.cleanPlayIndex,
          efficiency: performance.efficiency
        },
        matchState.matchId
      );
    }

    // 4. Update Mission progress
    const missionUpdates = this.missionBrain.updateMissionProgress(
      playerId, 
      performance.metrics
    );

    // 5. Update Prestige points
    const prestigeGain = this.prestigeSystem.addPrestigePoints(
      playerId, 
      Math.floor(performance.score * 0.1)
    );

    // 6. Update Retention model
    this.retentionModel.updateSessionData(
      playerId, 
      Date.now() - session.startTime,
      result,
      performance.score
    );

    // 7. System metrics tracking
    this.systemMetrics.recordMatchCompletion({
      playerId,
      result,
      performance,
      systemsEngaged: {
        events: session.activeEvents.length,
        missions: Array.isArray(missionUpdates) ? missionUpdates.length : 0,
        prestige: prestigeGain > 0,
        esports: mmrChange !== 0,
        retention: true
      }
    });
  }

  /**
   * Handle event rewards distribution
   */
  public distributeEventRewards(playerId: string, eventId: string): void {
    const rewards = this.eventArchitecture.getEventRewards(playerId, eventId);
    if (!rewards) return;

    // Apply prestige multipliers for cosmetic rewards
    const prestigeMultiplier = this.prestigeSystem.getRewardMultiplier(playerId);
    const adjustedRewards = {
      ...rewards,
      seasonScore: Math.floor(rewards.seasonScore * prestigeMultiplier)
    };

    // Update economy monitoring
    this.eventArchitecture.getEconomyMetrics();

    // Trigger retention intervention if significant reward
    if (adjustedRewards.diamonds > 50) {
      this.retentionModel.triggerIntervention(
        playerId, 
        'reward_pacing', 
        'medium'
      );
    }
  }

  /**
   * Handle mission completion rewards
   */
  public completeMission(playerId: string, missionId: string): void {
    const mission = this.missionBrain.completeMission(playerId, missionId);
    if (!mission) return;

    // Mission completion contributes to prestige
    this.prestigeSystem.addMissionCompletion(playerId, mission);

    // Update retention with mastery feedback
    this.retentionModel.triggerIntervention(
      playerId, 
      'mastery_feedback', 
      mission.type === 'weekly' ? 'high' : 'medium'
    );
  }

  /**
   * Handle prestige tier advancement
   */
  public handlePrestigeAdvancement(playerId: string): void {
    const advancement = this.prestigeSystem.checkAdvancement(playerId);
    if (!advancement.advanced) return;

    // Prestige advancement triggers retention celebration
    this.retentionModel.triggerIntervention(
      playerId, 
      'mastery_feedback', 
      'high'
    );

    // Update visual identity
    this.prestigeSystem.applyVisualRewards(playerId, advancement.rewards);

    // System metrics
    this.systemMetrics.recordPrestigeAdvancement(playerId, advancement.newTier);
  }

  /**
   * Handle anti-cheat violations
   */
  private handleAntiCheatViolation(
    playerId: string, 
    violation: AntiCheatViolation
  ): void {
    // Apply restrictions based on severity
    this.antiCheatSystem.applyRestriction(playerId, violation);

    // Remove from active events
    const session = this.playerSessions.get(playerId);
    if (session) {
      for (const eventId of session.activeEvents) {
        this.eventArchitecture.deactivateEvent(eventId);
      }
    }

    // Update retention with negative impact
    this.retentionModel.recordViolation(playerId, violation);

    // System metrics
    this.systemMetrics.recordAntiCheatViolation(playerId, violation);
  }

  /**
   * Get comprehensive player status
   */
  public getPlayerStatus(playerId: string): PlayerStatus {
    const session = this.playerSessions.get(playerId);
    if (!session) return null;

    return {
      playerId,
      prestige: session.prestigeData,
      esports: session.esportsData,
      activeEvents: session.activeEvents.map(id => 
        this.eventArchitecture.getEventConfig(id)
      ),
      activeMissions: this.missionBrain.getPlayerMissions(playerId),
      retentionScore: session.retentionProfile.retentionScore,
      antiCheatStatus: session.antiCheatProfile.trustScore,
      systemMetrics: this.systemMetrics.getPlayerMetrics(playerId)
    };
  }

  /**
   * Season reset and maintenance
   */
  public performSeasonReset(): void {
    // Partial MMR reset for esports
    this.esportsMode.performSeasonReset();

    // Archive prestige data
    this.prestigeSystem.archiveSeasonData();

    // Reset event economy
    this.eventArchitecture.resetEconomyMetrics();

    // Generate new seasonal missions
    this.missionBrain.generateSeasonalMissions();

    // Update retention model for new season
    this.retentionModel.prepareNewSeason();

    // System metrics
    this.systemMetrics.recordSeasonReset();
  }

  /**
   * Cleanup expired data
   */
  public performMaintenance(): void {
    // Clean up expired events
    const activeEvents = this.eventArchitecture.getActiveEvents();
    const now = Date.now();
    
    for (const event of activeEvents) {
      if (event.activationWindow.end.getTime() < now) {
        this.eventArchitecture.deactivateEvent(event.eventId);
      }
    }

    // Clean up old anti-cheat data
    this.antiCheatSystem.cleanupOldData();

    // Archive old retention data
    this.retentionModel.archiveOldData();

    // System metrics
    this.systemMetrics.recordMaintenance();
  }

  /**
   * Get system health metrics
   */
  public getSystemHealth(): SystemHealth {
    return {
      eventSystem: this.eventArchitecture.getEconomyMetrics(),
      missionSystem: this.missionBrain.getSystemMetrics(),
      prestigeSystem: this.prestigeSystem.getSystemMetrics(),
      esportsSystem: this.esportsMode.getSystemMetrics(),
      antiCheatSystem: this.antiCheatSystem.getSystemMetrics(),
      retentionSystem: this.retentionModel.getSystemMetrics(),
      matchEngine: this.matchEngine.getSystemMetrics(),
      integration: this.systemMetrics.getMetrics()
    };
  }

  /**
   * End player session
   */
  public endPlayerSession(playerId: string): void {
    const session = this.playerSessions.get(playerId);
    if (!session) return;

    // Final retention update
    this.retentionModel.endSession(playerId);

    // Clean up session data
    this.playerSessions.delete(playerId);

    // System metrics
    this.systemMetrics.recordSessionEnd(playerId, session);
  }

  /**
   * Dispose all systems
   */
  public dispose(): void {
    this.eventArchitecture.dispose();
    this.missionBrain.dispose();
    this.prestigeSystem.dispose();
    this.esportsMode.dispose();
    this.antiCheatSystem.dispose();
    this.retentionModel.dispose();
    this.matchEngine.dispose();
    this.playerSessions.clear();
    this.systemMetrics.dispose();
  }
}

// Supporting interfaces
interface PlayerSession {
  playerId: string;
  startTime: number;
  playerState: PlayerState;
  activeEvents: string[];
  activeMissions: string[];
  prestigeData: any;
  esportsData: any;
  retentionProfile: any;
  antiCheatProfile: any;
  matchPhysics: any;
}

interface MatchPerformance {
  score: number;
  cleanPlayIndex: number;
  efficiency: number;
  metrics: { [key: string]: number };
}

interface PlayerStatus {
  playerId: string;
  prestige: any;
  esports: any;
  activeEvents: any[];
  activeMissions: any[];
  retentionScore: number;
  antiCheatStatus: number;
  systemMetrics: any;
}

interface AntiCheatViolation {
  type: string;
  severity: 'low' | 'medium' | 'high';
  description: string;
  evidence: any;
}

interface SystemHealth {
  eventSystem: any;
  missionSystem: any;
  prestigeSystem: any;
  esportsSystem: any;
  antiCheatSystem: any;
  retentionSystem: any;
  matchEngine: any;
  integration: any;
}

class SystemMetrics {
  private metrics: Map<string, any> = new Map();

  public recordMatchCompletion(data: any): void {
    // Track system engagement metrics
  }

  public recordPrestigeAdvancement(playerId: string, tier: number): void {
    // Track prestige progression
  }

  public recordAntiCheatViolation(playerId: string, violation: AntiCheatViolation): void {
    // Track security metrics
  }

  public recordSeasonReset(): void {
    // Track season maintenance
  }

  public recordMaintenance(): void {
    // Track system maintenance
  }

  public recordSessionEnd(playerId: string, session: PlayerSession): void {
    // Track session analytics
  }

  public getPlayerMetrics(playerId: string): any {
    return this.metrics.get(playerId) || {};
  }

  public getMetrics(): any {
    return {
      totalSessions: this.metrics.size,
      systemHealth: 'optimal',
      lastUpdate: Date.now()
    };
  }

  public dispose(): void {
    this.metrics.clear();
  }
}
